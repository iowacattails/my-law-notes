<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Law Note Publisher</title>
<style>
  body{background:#ff0;padding:20px;font-family:Arial;}
  h1{font-size:2.5em;text-align:center;}
  input,textarea,button{width:100%;padding:15px;margin:10px 0;font-size:1.2em;}
  button{background:#000;color:#ff0;border:none;padding:25px;font-weight:bold;cursor:pointer;}
  .section{border:4px solid #000;padding:30px;margin:30px 0;background:#fff;}
  .thumb{max-width:50%;margin:20px auto;display:block;border:4px solid #000;}
  .tag-btn{display:inline-block;background:#fff;color:#000;padding:10px 20px;margin:8px;border:3px solid #000;border-radius:10px;cursor:pointer;}
  .tag-btn.selected{background:#000;color:#ff0;}
  #preview{background:#fff;padding:40px;margin-top:50px;border:4px solid #000;}
  #status{color:#000;font-weight:bold;font-size:1.5em;}
</style>
</head>
<body>
<h1>Law Note Publisher</h1>

<input type="text" id="title" placeholder="Page Title" oninput="updatePreview()">

<div id="sections">
  <div class="section">
    <input type="text" class="header" placeholder="Section Header (optional)" oninput="updatePreview()">
    <textarea rows="8" class="note" placeholder="Main note / quote" oninput="updatePreview()"></textarea>
    <div class="images"></div>
    <button class="add" onclick="addPhoto(this)">+ Add Photo</button>
    <input type="text" class="cite" placeholder="Citation (optional)" oninput="updatePreview()">
    <input type="url" class="source" placeholder="Source URL (optional)" oninput="updatePreview()">
    <button class="add" onclick="addSection()">+ Add Another Section</button>
  </div>
</div>

<div style="margin:50px 0;">
  <strong>Tags:</strong><br>
  <span class="tag-btn" onclick="toggle(this)">Common Law</span>
  <span class="tag-btn" onclick="toggle(this)">Trial by Jury</span>
  <span class="tag-btn" onclick="toggle(this)">Vicinage</span>
  <input type="text" placeholder="Custom tag + Enter" onkeydown="if(event.key==='Enter')addCustom(this)">
  <div id="tags">Tags: none</div>
</div>

<button onclick="publish()">ONE-CLICK PUBLISH (Images + Page)</button>
<div id="status">Status: Ready</div>

<div id="preview"><h2>Live Preview</h2><div id="previewContent"></div></div>

<script>
let tags=[];
function toggle(el){const t=el.textContent.trim();if(tags.includes(t))tags=tags.filter(x=>x!==t),el.classList.remove('selected');else tags.push(t),el.classList.add('selected');document.getElementById('tags').textContent='Tags: '+tags.join(', ')||'none';updatePreview()}
function addCustom(i){const t=i.value.trim();if(t)tags.push(t),i.value='';document.getElementById('tags').textContent='Tags: '+tags.join(', ')||'none';updatePreview()}

function addSection(){/* same as before */ const div=document.createElement('div');div.className='section';div.innerHTML=`...`;document.getElementById('sections').appendChild(div);updatePreview()}

function addPhoto(btn){/* same as before */}

async function publish(){
  const title=document.getElementById('title').value.trim();
  if(!title) return alert("Add a title!");
  const slug=title.toLowerCase().replace(/[^a-z0-9]+/g,'-');
  const filename=slug+'.html';
  document.getElementById('status').textContent='Status: Publishing...';

  // Collect images
  const imagePromises=[];
  let count=0;
  document.querySelectorAll('.thumb').forEach(img=>{
    if(img.src.startsWith('data:')){
      count++;
      const ext=img.src.split(';')[0].split('/')[1];
      const name=`${slug}-${count}.${ext||'jpg'}`;
      const base64=img.src.split(',')[1];
      imagePromises.push(fetch(`https://api.github.com/repos/iowacattails/my-law-notes/contents/images/${name}`,{
        method:'PUT',
        headers:{Authorization:'token '+prompt('Enter your PAT token (one time setup)'), 'Content-Type':'application/json'},
        body:JSON.stringify({message:`Add image ${name}`, content:base64})
      }));
    }
  });

  // Commit images first
  try{
    await Promise.all(imagePromises);
  }catch(e){alert('Image commit failed â€” check token/permissions'); return;}

  // Build and commit page HTML
  let html=`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>${title}</title><style>body{background:#ff0;margin:40px;font-family:Georgia;font-size:2.2em;line-height:2.1;}img{max-width:50%;margin:60px auto;display:block;border:4px solid #000;}</style></head><body><h1>${title}</h1><p>`;
  let imgCount=0;
  document.querySelectorAll('.section').forEach(sec=>{
    /* build html same as before, using images/${slug}-${++imgCount}.jpg */
  });
  html+=`</body></html>`;

  const pageBase64=btoa(unescape(encodeURIComponent(html)));
  fetch(`https://api.github.com/repos/iowacattails/my-law-notes/contents/${filename}`,{
    method:'PUT',
    headers:{Authorization:'token '+localStorage.getItem('pat')||prompt('PAT again if needed'), 'Content-Type':'application/json'},
    body:JSON.stringify({message:`Publish ${title}`, content:pageBase64})
  }).then(r=>r.json()).then(()=> {
    document.getElementById('status').textContent='Status: Published! Index updating in ~60s...';
    // Trigger index update via dispatch or just wait for push trigger
  }).catch(()=>alert('Page commit failed'));
}
updatePreview();
</script>
</body>
</html>
