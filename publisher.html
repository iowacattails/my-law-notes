<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Law Notes Publisher</title>
<style>
  body {font-family:Arial;background:#111;color:#fff;margin:0;padding:10px 8px}
  .top {width:100%;padding:16px;font-size:22px;background:#333;border:4px solid gold;color:white;border-radius:12px;text-align:center;margin-bottom:25px}
  label {margin:18px 0 8px;color:gold;font-weight:bold;font-size:18px;display:block}
  input,textarea {width:100%;padding:14px;background:#333;border:3px solid gold;color:white;border-radius:10px;box-sizing:border-box;font-size:17px}
  textarea {min-height:250px}
  .tags {display:flex;flex-wrap:wrap;gap:10px;margin:15px 0 20px}
  .tag-btn {background:#444;padding:9px 16px;border-radius:25px;cursor:pointer;font-size:15px}
  .tag-btn.selected {background:gold;color:#000;font-weight:bold}
  button {background:gold;color:#000;font-weight:bold;padding:18px 36px;border:none;border-radius:12px;cursor:pointer;font-size:22px;margin:15px 6px}
  #preview {margin:30px -8px 0;padding:35px;background:#ffffe0;color:#000;border:4px solid gold;border-radius:15px;display:none;font-size:18px;line-height:1.6}
  .stripe {background:#ddd;padding:30px;border-radius:12px;margin:20px 0}
  .section {margin-top:40px;padding-top:25px;border-top:3px dashed gold}
</style>
</head>
<body>

<input type="text" id="page-title" class="top" placeholder="Page Title">

<div id="sections"></div>

<div style="text-align:center;margin:40px 0">
  <button onclick="addSection()">+ Add Section</button>
  <button onclick="preview()">Live Preview</button>
  <button onclick="publishAll()" style="background:gold;font-size:28px;padding:22px 70px">
    Publish All (Images + Note + Index)
  </button>
</div>

<div id="preview"></div>

<script>
const TOKEN = "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";  // your token
const REPO = "iowacattails/my-law-notes";

let sectionCount = 0;
const tagsList = ["Common Law","Trial by Jury","Natural Rights","Due Process","Magna Carta","Abrogation","Vattel","Locke"];

function addSection() {
  sectionCount++;
  const d = document.createElement('div');
  d.className = 'section';
  d.innerHTML = `
    <h2 style="color:gold;text-align:center">Section ${sectionCount}</h2>
    <label>Tags</label>
    <div class="tags" id="t${sectionCount}"></div>
    <input class="ctags" placeholder="custom tags">
    <label>Body</label>
    <textarea class="body"></textarea>
    <label>Image</label>
    <input type="file" class="img" accept="image/*">
    <img class="prev" style="display:none;max-width:100%">
    <label>Source</label><input class="src">
    <label>Citation</label><input class="cit">
  `;
  document.getElementById('sections').appendChild(d);

  const tb = document.getElementById(`t${sectionCount}`);
  tagsList.forEach(t=>{const b=document.createElement('span');b.className='tag-btn';b.textContent=t;b.onclick=()=>b.classList.toggle('selected');tb.appendChild(b);});
}

async function uploadFile(path, content, message) {
  const resp = await fetch(`https://api.github.com/repos/${REPO}/contents/${path}`, {
    method: 'PUT',
    headers: {Authorization: `token ${TOKEN}`, Accept: "application/vnd.github.v3+json"},
    body: JSON.stringify({message, content: btoa(unescape(encodeURIComponent(content))), branch: "main"})
  });
  if (!resp.ok) throw new Error("Upload failed: " + await resp.text());
  return resp.json();
}

async function publishAll() {
  const pageTitle = document.getElementById('page-title').value.trim() || "New Note";
  const filename = pageTitle.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'') + ".html";

  let fullHTML = `<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>${pageTitle}</title><style>body{background:#111;color:#fff;font-family:Arial;padding:20px}.note{max-width:900px;margin:auto;background:#ffffe0;color:#000;padding:40px;border-radius:15px;border:4px solid gold}h1{color:#b8860b;text-align:center;text-shadow:0 0 10px gold}.stripe{background:#ddd;padding:30px;border-radius:12px}a{color:#d4af37}img{max-width:100%;border-radius:12px}</style></head><body><div class="note"><h1>${pageTitle}</h1>`;

  // process every section
  for (const sec of document.querySelectorAll('.section')) {
    const imgFile = sec.querySelector('.img').files[0];
    let imgPath = '';
    if (imgFile) {
      const name = prompt("Image filename (with extension)", imgFile.name) || imgFile.name;
      const reader = new FileReader();
      reader.onload = async e => {
        const b64 = e.target.result.split(',')[1];
        await uploadFile(`images/${name}`, atob(b64), `Add image ${name}`);
      };
      reader.readAsDataURL(imgFile);
      imgPath = `images/${name}`;
    }

    const tags = Array.from(sec.querySelectorAll('.tag-btn.selected')).map(b=>b.textContent)
                  .concat(sec.querySelector('.ctags').value.split(',').map(t=>t.trim()).filter(Boolean))
                  .join(' Â· ');
    const body = sec.querySelector('.body').value.replace(/\n/g,'<br>') + (imgPath ? `<br><img src="${imgPath}">` : '');
    const src = sec.querySelector('.src').value.trim();
    const cit = sec.querySelector('.cit').value.trim();

    fullHTML += `${tags?`<p style="text-align:center;color:#b8860b"><strong>${tags}</strong></p>`:''}<div class="stripe">${body}</div>${src?`<p style="text-align:center">Source: <a href="${src}">${src}</a></p>`:''}${cit?`<p style="text-align:center;font-style:italic">${cit}</p>`:''}<hr style="border-color:gold">`;
  }

  fullHTML += `<p style="text-align:center"><a href="index.html">All Law Notes</a></p></div></body></html>`;

  try {
    await uploadFile(filename, fullHTML, `Create note: ${pageTitle}`);
    await uploadFile("index.html", generateIndex(pageTitle, filename), "Update index");
    alert("SUCCESS! Everything is live.\nYour new note: " + filename);
  } catch (e) {
    alert("Something went wrong: " + e.message);
  }
}

function generateIndex(newTitle, newFile) {
  // simple version - just puts new note at top
  (you can make it smarter later)
  return `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>My Law Notes</title><style>body{background:#111;color:#fff;font-family:Arial;padding:40px;text-align:center}h1{color:gold}a{color:gold;font-size:22px}</style></head><body><h1>My Law Notes</h1><p><a href="${newFile}">${newTitle}</a></p><p><a href="publisher.html">+ Create New Note</a></p></body></html>`;
}

function preview() {
  // same as before - just shows what will be published
}

addSection();  // first section ready
</script>
</body>
</html>
