<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Law Note Publisher</title>
<style>
  body {background:#ff0; margin:0; padding:10px; font-family:Arial;}
  h1 {font-size:2.2em; text-align:center; margin:20px 0 80px 0;}
  input, textarea, button {width:100%; padding:12px; margin:20px 0; font-size:1em; box-sizing:border-box;}
  button {background:#000; color:#ff0; border:none; padding:20px; font-weight:bold; cursor:pointer;}
  .section {border:3px solid #000; padding:30px; margin:30px 0; background:#fff;}
  .add {background:#333; color:#ff0;}
  .thumb {max-width:50%; margin:40px auto; display:block; border:4px solid #000; box-shadow:6px 6px 0 #000;}
  .delete-img {position:absolute; top:10px; right:10px; background:#c00; color:#fff; border:none; width:40px; height:40px; font-size:28px; cursor:pointer;}
  .thumb-container {position:relative; display:block; text-align:center;}
  #preview {background:#ff0; padding:40px; margin-top:50px; border:4px solid #000;}
</style>
</head>
<body>

<h1>Law Note Publisher</h1>

<input type="text" id="title" placeholder="Page Title" oninput="updatePreview()">

<div id="sections">
  <div class="section">
    <input type="text" class="header" placeholder="Section Header (optional)" oninput="updatePreview()">
    <textarea rows="8" class="note" placeholder="Main note / quote" oninput="updatePreview()"></textarea>
    
    <div class="images">
      <div class="thumb-container">
        <input type="file" accept="image/*" class="image" onchange="handleImage(this)">
        <img class="thumb" style="display:none;">
        <button class="delete-img" style="display:none;" onclick="deleteImage(this)">X</button>
      </div>
    </div>
    <button class="add" onclick="addPhoto(this)">+ Add Another Photo</button>
    
    <input type="text" class="cite" placeholder="Citation (optional)" oninput="updatePreview()">
    <input type="url" class="source" placeholder="Source URL (optional)" oninput="updatePreview()">
    
    <button class="add" onclick="addSection()">+ Add Another Section</button>
  </div>
</div>

<button onclick="publish()">PUBLISH NEW PAGE</button>

<div id="preview"><h2>Live Preview</h2><div id="previewContent">Start typing...</div></div>

<script>
let globalImageData = {}; // Store image data to persist across clones

function addSection() {
  const clone = document.querySelector('.section').cloneNode(true);
  clone.querySelectorAll('input, textarea').forEach(el => el.value = '');
  clone.querySelectorAll('.thumb, .delete-img').forEach(el => el.style.display = 'none');
  document.getElementById('sections').appendChild(clone);
  updatePreview();
}

function addPhoto(btn) {
  const container = document.createElement('div');
  container.className = 'thumb-container';
  container.innerHTML = `<input type="file" accept="image/*" class="image" onchange="handleImage(this)">
                        <img class="thumb" style="display:none;">
                        <button class="delete-img" style="display:none;" onclick="deleteImage(this)">X</button>`;
  btn.parentNode.insertBefore(container, btn);
  updatePreview();
}

function handleImage(input) {
  const container = input.parentNode;
  const img = container.querySelector('.thumb');
  const del = container.querySelector('.delete-img');
  if (input.files && input.files[0]) {
    const blobUrl = URL.createObjectURL(input.files[0]);
    img.src = blobUrl;
    img.style.display = 'block';
    del.style.display = 'block';
    globalImageData[blobUrl] = input.files[0]; // Save the file for persistence
  }
  updatePreview();
}

function deleteImage(btn) {
  const container = btn.parentNode;
  const img = container.querySelector('.thumb');
  URL.revokeObjectURL(img.src); // Clean up blob
  img.src = '';
  img.style.display = 'none';
  btn.style.display = 'none';
  container.querySelector('input').value = '';
  delete globalImageData[img.src];
  updatePreview();
}

function updatePreview() {
  const title = document.getElementById('title').value.trim() || "Untitled Page";
  let html = `<h1>${title}</h1><p>`;
  
  document.querySelectorAll('.section').forEach(sec => {
    const header = sec.querySelector('.header').value.trim();
    const note = sec.querySelector('.note').value.trim();
    const cite = sec.querySelector('.cite').value.trim();
    const source = sec.querySelector('.source').value.trim();

    if (header) html += `<br><br><strong>${header}</strong><br>`;
    if (note) html += note.replace(/\n/g, '<br><br>');

    sec.querySelectorAll('.thumb').forEach(img => {
      if (img.src && img.style.display !== 'none') {
        html += `<br><div style="text-align:center"><img src="${img.src}" style="max-width:50%;"></div><br>`;
      }
    });

    if (cite || source) {
      html += `<br><em>Citation: ${cite || '—'}</em>`;
      if (source) html += ` — <a href="${source}" target="_blank">Source</a>`;
      html += `<br><br>`;
    }
  });

  html += `</p><a href="index.html" class="back">← Return to Law Book Links</a>`;
  document.getElementById('previewContent').innerHTML = html;
}

function publish() {
  const title = document.getElementById('title').value.trim() || "Untitled";
  if (!title) return alert("Add a title first!");

  const slug = title.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '') + ".html";

  let html = `<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>${title}</title>
<style>
  body {background:#ff0;margin:40px;font-family:Arial;font-size:1.8em;line-height:1.8;max-width:900px;margin:40px auto;}
  h1 {font-size:3em;text-align:center;margin-bottom:80px;}
  .back {display:block;background:#fff;color:#000;text-align:center;padding:20px;margin:4em auto;font-size:1.6em;border:3px solid #000;text-decoration:none;max-width:500px;font-weight:bold;}
  img {max-width:50%;margin:60px auto;display:block;border:4px solid #000;box-shadow:8px 8px 0 #000;}
</style>
</head>
<body>
<h1>${title}</h1>
<p>`;

  document.querySelectorAll('.section').forEach(sec => {
    const header = sec.querySelector('.header').value.trim();
    const note = sec.querySelector('.note').value.trim();
    const cite = sec.querySelector('.cite').value.trim();
    const source = sec.querySelector('.source').value.trim();

    if (header) html += `<br><br><strong>${header}</strong><br>`;
    if (note) html += note.replace(/\n/g, '<br><br>');

    sec.querySelectorAll('.thumb').forEach(img => {
      if (img.src && img.style.display !== 'none') {
        html += `<br><div style="text-align:center"><img src="${img.src}" style="max-width:50%;"></div><br>`;
      }
    });

    if (cite || source) {
      html += `<br><em>Citation: ${cite || '—'}</em>`;
      if (source) html += ` — <a href="${source}" target="_blank">Source</a>`;
      html += `<br><br>`;
    }
  });

  html += `</p><a href="index.html" class="back">← Return to Law Book Links</a></body>
</html>`;

  const url = `https://github.com/iowacattails/my-law-notes/new/main?filename=${slug}&value=${encodeURIComponent(html)}`;
  window.open(url, '_blank');
  alert("GitHub opened — tap Commit to publish!");
}
</script>

</body>
</html>
