<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Law Note Publisher</title>
<style>
  body {background:#ff0; margin:0; padding:20px; font-family:Arial;}
  h1 {font-size:2.5em; text-align:center; margin:40px 0;}
  input, textarea, button {width:100%; padding:15px; margin:10px 0; font-size:1.2em; box-sizing:border-box;}
  button {background:#000; color:#ff0; border:none; padding:25px; font-weight:bold; cursor:pointer;}
  .section {border:4px solid #000; padding:30px; margin:30px 0; background:#fff;}
  .thumb {max-width:50%; margin:40px auto; display:block; border:4px solid #000;}
  .tag-btn {display:inline-block; background:#fff; color:#000; padding:10px 20px; margin:8px; border:3px solid #000; border-radius:10px; cursor:pointer;}
  .tag-btn.selected {background:#000; color:#ff0;}
  #selected-tags {margin:20px 0; font-weight:bold; font-size:1.3em;}
  #preview {background:#fff; padding:40px; margin-top:50px; border:4px solid #000;}
  #edit-mode {background:#ffff99; padding:20px; margin:20px 0; border:3px solid #000;}
</style>
</head>
<body>

<h1>Law Note Publisher</h1>

<div id="edit-mode">
  <input type="text" id="edit-slug" placeholder="Load page to edit (e.g. test.html)" onkeydown="if(event.key==='Enter' || event.key==='Return') loadPage(this.value)">
  <small>Type filename and press Return</small>
</div>

<input type="text" id="title" placeholder="Page Title" oninput="updatePreview()">

<div id="sections">
  <div class="section">
    <input type="text" class="header" placeholder="Section Header (optional)" oninput="updatePreview()">
    <textarea rows="8" class="note" placeholder="Main note / quote" oninput="updatePreview()"></textarea>
    <div class="images">
      <div class="thumb-container">
        <input type="file" accept="image/*" class="image" onchange="handleImage(this)">
        <img class="thumb" style="display:none;">
        <button class="delete-img" style="display:none;" onclick="deleteImage(this)">X</button>
      </div>
    </div>
    <button class="add" onclick="addPhoto(this)">+ Add Another Photo</button>
    <input type="text" class="cite" placeholder="Citation (optional)" oninput="updatePreview()">
    <input type="url" class="source" placeholder="Source URL (optional)" oninput="updatePreview()">
    <button class="add" onclick="addSection()">+ Add Another Section</button>
  </div>
</div>

<div style="margin:50px 0;">
  <strong>Tags (tap presets or type your own):</strong><br>
  <span class="tag-btn" onclick="toggleTag(this)">Common Law</span>
  <span class="tag-btn" onclick="toggleTag(this)">Trial by Jury</span>
  <span class="tag-btn" onclick="toggleTag(this)">Natural Rights</span>
  <span class="tag-btn" onclick="toggleTag(this)">Due Process</span>
  <span class="tag-btn" onclick="toggleTag(this)">Magna Carta</span>
  <span class="tag-btn" onclick="toggleTag(this)">Abrogation</span>
  <span class="tag-btn" onclick="toggleTag(this)">Vattel</span>
  <span class="tag-btn" onclick="toggleTag(this)">Locke</span>
  <input type="text" placeholder="Type tag + Return" style="padding:12px;margin:10px;width:80%;font-size:1.2em;" onkeydown="if(event.key==='Enter' || event.key==='Return') addCustom(this)">
  <div id="selected-tags">Tags: none</div>
</div>

<button onclick="publish()">PUBLISH / UPDATE PAGE</button>

<div id="preview"><h2>Live Preview</h2><div id="previewContent">Start typing...</div></div>

<script>
let selectedTags = [];

function toggleTag(el) {
  const t = el.textContent.trim();
  if (selectedTags.includes(t)) {
    selectedTags = selectedTags.filter(x => x !== t);
    el.classList.remove('selected');
  } else {
    selectedTags.push(t);
    el.classList.add('selected');
  }
  updateTags();
}

function addCustom(i) {
  const t = i.value.trim();
  if (t && !selectedTags.includes(t)) selectedTags.push(t), i.value = '';
  updateTags();
}

function updateTags() {
  document.getElementById('selected-tags').textContent = 'Tags: ' + (selectedTags.join(', ') || 'none');
  updatePreview();
}

function addSection() {
  const div = document.createElement('div');
  div.className = 'section';
  div.innerHTML = `
    <input type="text" class="header" placeholder="Section Header (optional)" oninput="updatePreview()">
    <textarea rows="8" class="note" placeholder="Main note / quote" oninput="updatePreview()"></textarea>
    <div class="images"></div>
    <button class="add" onclick="addPhoto(this)">+ Add Another Photo</button>
    <input type="text" class="cite" placeholder="Citation (optional)" oninput="updatePreview()">
    <input type="url" class="source" placeholder="Source URL (optional)" oninput="updatePreview()">
    <button class="add" onclick="addSection()">+ Add Another Section</button>
  `;
  document.getElementById('sections').appendChild(div);
  updatePreview();
}

function addPhoto(btn) {
  const images = btn.previousElementSibling;
  const container = document.createElement('div');
  container.className = 'thumb-container';
  container.innerHTML = `<input type="file" accept="image/*" onchange="handleImage(this)">
                        <img class="thumb" style="display:none;">
                        <button class="delete-img" style="display:none;" onclick="deleteImage(this)">X</button>`;
  images.appendChild(container);
}

function handleImage(input) {
  const container = input.parentNode;
  const img = container.querySelector('.thumb');
  const del = container.querySelector('.delete-img');
  if (input.files && input.files[0]) {
    img.src = URL.createObjectURL(input.files[0]);
    img.style.display = 'block';
    del.style.display = 'block';
  }
  updatePreview();
}

function deleteImage(btn) {
  const container = btn.parentNode;
  const img = container.querySelector('.thumb');
  URL.revokeObjectURL(img.src);
  img.src = '';
  img.style.display = 'none';
  btn.style.display = 'none';
  container.querySelector('input').value = '';
  updatePreview();
}

function updatePreview() {
  const title = document.getElementById('title').value.trim() || "Untitled";
  let html = `<h1>${title}</h1><p>`;
  document.querySelectorAll('.section').forEach(sec => {
    const header = sec.querySelector('.header').value.trim();
    const note = sec.querySelector('.note').value.trim();
    const cite = sec.querySelector('.cite').value.trim();
    const source = sec.querySelector('.source').value.trim();
    if (header) html += `<br><br><strong>${header}</strong><br>`;
    if (note) html += note.replace(/\n/g, '<br><br>');
    sec.querySelectorAll('.thumb').forEach(img => {
      if (img.src && img.style.display !== 'none') {
        html += `<br><div style="text-align:center"><img src="${img.src}" style="max-width:50%;"></div><br>`;
      }
    });
    if (cite || source) {
      html += `<br><em>Citation: ${cite || '—'}</em>`;
      if (source) html += ` — <a href="${source}" target="_blank">Source</a>`;
      html += `<br><br>`;
    }
  });
  html += `<em>Tags: ${selectedTags.join(', ') || 'none'}</em>`;
  html += `<br><a href="index.html" class="back">← Return to Law Book Links</a>`;
  document.getElementById('previewContent').innerHTML = html;
}

async function loadPage(slug) {
  if (!slug.endsWith('.html')) slug += '.html';
  try {
    const res = await fetch(slug + '?t=' + Date.now());
    const text = await res.text();
    const parser = new DOMParser();
    const doc = parser.parseFromString(text, 'text/html');

    document.getElementById('title').value = doc.querySelector('title').textContent;
    selectedTags = [];
    const tagMatch = text.match(/<em>Tags: (.*?)<\/em>/);
    if (tagMatch) {
      tagMatch[1].split(', ').forEach(t => {
        t = t.trim();
        if (t) selectedTags.push(t);
        document.querySelectorAll('.tag-btn').forEach(btn => {
          if (btn.textContent.trim() === t) btn.classList.add('selected');
        });
      });
    }
    updateTags();

    // Clear current sections
    document.getElementById('sections').innerHTML = '<div class="section"></div>';
    const mainSection = document.getElementById('sections').firstChild;
    mainSection.innerHTML = `
      <input type="text" class="header" placeholder="Section Header (optional)" oninput="updatePreview()">
      <textarea rows="8" class="note" placeholder="Main note / quote" oninput="updatePreview()"></textarea>
      <div class="images"></div>
      <button class="add" onclick="addPhoto(this)">+ Add Another Photo</button>
      <input type="text" class="cite" placeholder="Citation (optional)" oninput="updatePreview()">
      <input type="url" class="source" placeholder="Source URL (optional)" oninput="updatePreview()">
      <button class="add" onclick="addSection()">+ Add Another Section</button>
    `;

    // Very simple text extraction (good enough for now)
    const bodyText = doc.body.innerText;
    const lines = bodyText.split('\n').filter(l => l.trim() && !l.includes('Tags:') && !l.includes('Return to Law Book Links'));
    if (lines.length) mainSection.querySelector('.note').value = lines.join('\n');

    updatePreview();
    alert('Page loaded — edit and hit PUBLISH to update!');
  } catch (e) {
    alert('Page not found or error loading. Check the filename.');
  }
}

function publish() {
  const title = document.getElementById('title').value.trim();
  if (!title) return alert("Add a title!");
  const slug = title.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '') + '.html';
  let html = `<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><title>${title}</title><style>body{background:#ff0;margin:40px;font-family:Arial;font-size:1.8em;line-height:1.8;max-width:900px;margin:40px auto;}h1{font-size:3em;text-align:center;margin-bottom:80px;}.back{display:block;background:#fff;color:#000;padding:30px;margin:60px auto;font-size:1.8em;border:4px solid #000;text-decoration:none;max-width:600px;text-align:center;font-weight:bold;}img{max-width:50%;margin:60px auto;display:block;border:4px solid #000;}</style></head><body><h1>${title}</h1><p>`;

  document.querySelectorAll('.section').forEach(sec => {
    const header = sec.querySelector('.header').value.trim();
    const note = sec.querySelector('.note').value.trim();
    if (header) html += `<strong>${header}</strong><br><br>`;
    if (note) html += note.replace(/\n/g, '<br><br>') + '<br><br>';

    sec.querySelectorAll('.thumb').forEach(img => {
      if (img.src && img.style.display !== 'none') html += `<div style="text-align:center"><img src="${img.src}" style="max-width:50%;"></div><br>`;
    });

    const cite = sec.querySelector('.cite').value.trim();
    const source = sec.querySelector('.source').value.trim();
    if (cite || source) {
      html += `<em>Citation: ${cite || '—'}`;
      if (source) html += ` — <a href="${source}" target="_blank">Source</a>`;
      html += `</em><br><br>`;
    }
  });

  html += `<em>Tags: ${selectedTags.join(', ') || 'none'}</em>`;
  html += `<br><a href="index.html" class="back">← Return to Law Book Links</a></body></html>`;

  const url = `https://github.com/iowacattails/my-law-notes/new/main?filename=${slug}&value=${encodeURIComponent(html)}`;
  window.open(url, '_blank');
  alert('GitHub opened — tap Commit to publish/update!');
}
</script>
</body>
</html>
