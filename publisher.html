<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Law Note Publisher</title>
<style>
  body{background:#ff0;padding:20px;font-family:Arial;}
  h1{font-size:2.5em;text-align:center;margin-bottom: ║
  input,textarea,button{width:100%;padding:15px;margin:10px 0;font-size:1.2em;}
  button{background:#000;color:#ff0;border:none;padding:25px;font-weight:bold;cursor:pointer;}
  #commit-img{background:#c00;color:#fff;}
  .section{border:4px solid #000;padding:30px;margin:30px 0;background:#fff;}
  .thumb{max-width:50%;margin:20px auto;display:block;border:4px solid #000;}
  .tag-btn{display:inline-block;background:#fff;color:#000;padding:10px 20px;margin:8px;border:3px solid #000;border-radius:10px;cursor:pointer;}
  .tag-btn.selected{background:#000;color:#ff0;}
  #preview{background:#fff;padding:40px;margin-top:50px;border:4px solid #000;}
</style>
</head>
<body onload="loadDraft()">
<h1>Law Note Publisher</h1>

<input type="text" id="title" placeholder="Page Title" oninput="saveDraft();updatePreview()">

<div id="sections">
  <div class="section">
    <input type="text" class="header" placeholder="Section Header (optional)" oninput="saveDraft();updatePreview()">
    <textarea rows="8" class="note" placeholder="Main note / quote" oninput="saveDraft();updatePreview()"></textarea>
    <div class="images"></div>
    <button class="add" onclick="addPhoto(this)">+ Add Photo</button>
    <input type="text" class="cite" placeholder="Citation (optional)" oninput="saveDraft();updatePreview()">
    <input type="url" class="source" placeholder="Source URL (optional)" oninput="saveDraft();updatePreview()">
    <button class="add" onclick="addSection()">+ Add Another Section</button>
  </div>
</div>

<div style="margin:50px 0;">
  <strong>Tags:</strong><br>
  <span class="tag-btn" onclick="toggle(this)">Common Law</span>
  <span class="tag-btn" onclick="toggle(this)">Trial by Jury</span>
  <span class="tag-btn" onclick="toggle(this)">Vicinage</span>
  <span class="tag-btn" onclick="toggle(this)">Due Process</span>
  <input type="text" placeholder="Custom tag + Enter" onkeydown="if(event.key==='Enter')addCustom(this)">
  <div id="tags">Tags: none</div>
</div>

<button id="commit-img" onclick="commitImages()">COMMIT IMAGES FIRST</button>
<button onclick="publish()">PUBLISH PAGE</button>

<div id="preview"><h2>Live Preview</h2><div id="previewContent"></div></div>

<script>
let tags=[];
function toggle(el){const t=el.textContent.trim();if(tags.includes(t))tags=tags.filter(x=>x!==t),el.classList.remove('selected');else tags.push(t),el.classList.add('selected');document.getElementById('tags').textContent='Tags: '+tags.join(', ')||'none';saveDraft();updatePreview()}
function addCustom(i){const t=i.value.trim();if(t)tags.push(t),i.value='';document.getElementById('tags').textContent='Tags: '+tags.join(', ')||'none';saveDraft();updatePreview()}

function addSection(){const div=document.createElement('div');div.className='section';div.innerHTML=`
<input type="text" class="header" placeholder="Section Header (optional)" oninput="saveDraft();updatePreview()">
<textarea rows="8" class="note" placeholder="Main note / quote" oninput="saveDraft();updatePreview()">
<div class="images"></div>
<button class="add" onclick="addPhoto(this)">+ Add Photo</button>
<input type="text" class="cite" placeholder="Citation (optional)" oninput="saveDraft();updatePreview()">
<input type="url" class="source" placeholder="Source URL (optional)" oninput="saveDraft();updatePreview()">
<button class="add" onclick="addSection()">+ Add Another Section</button>
`;document.getElementById('sections').appendChild(div);updatePreview()}

function addPhoto(btn){
  const images=btn.parentNode.querySelector('.images');
  const c=document.createElement('div');c.innerHTML=`<input type="file" accept="image/*"><img class="thumb" style="display:none;"><button onclick="this.parentNode.remove();saveDraft()">X</button>`;
  c.querySelector('input').onchange=e=>{
    if(e.target.files[0]){
      const reader=new FileReader();
      reader.onload=r=>{
        c.querySelector('.thumb').src=r.target.result;
        c.querySelector('.thumb').style.display='block';
      };
      reader.readAsDataURL(e.target.files[0]);
    }
  };
  images.appendChild(c);updatePreview();
}

function commitImages(){
  const title=document.getElementById('title').value.trim()|| "untitled";
  const slug=title.toLowerCase().replace(/[^a-z0-9]+/g,'-');
  let count=0;
  document.querySelectorAll('.thumb').forEach(img=>{
    if(img.src && img.src.startsWith('data:')){
      count++;
      const name=prompt(`Image ${count} name (e.g. ${slug}-${count}.jpg)`, `${slug}-${count}.jpg`);
      if(name) window.open(`https://github.com/iowacattails/my-law-notes/upload/main/images?filename=${name}`,'_blank');
    }
  });
  if(count===0) alert("No images!");
  else alert(`${count} image tab(s) opened — commit them, then PUBLISH`);
}

function updatePreview(){
  const title=document.getElementById('title').value.trim()|| "Untitled";
  let html=`<h1>${title}</h1><p>`;
  document.querySelectorAll('.section').forEach(sec=>{
    const h=sec.querySelector('.header').value.trim();
    const n=sec.querySelector('.note').value.trim();
    const c=sec.querySelector('.cite').value.trim();
    const s=sec.querySelector('.source').value.trim();
    if(h)html+=`<strong>${h}</strong><br><br>`;
    if(n)html+=n.replace(/\n/g,'<br><br>')+'<br><br>';
    sec.querySelectorAll('.thumb').forEach((img,i)=>{if(img.src)html+=`<div style="text-align:center"><img src="${img.src}" style="max-width:50%;"></div><br>`});
    if(c||s){html+=`<em>Citation: ${c||'—'}`;if(s)html+=` — <a href="${s}" target="_blank">Source</a>`;html+=`</em><br><br>`}
  });
  html+=`<em>Tags: ${tags.join(', ')||'none'}</em><br>`;
  html+=`<a href="index.html" style="background:#fff;color:#000;padding:30px;display:block;border:4px solid #000;">← Return to Law Book Links</a>`;
  document.getElementById('previewContent').innerHTML=html;
}

function publish(){
  const title=document.getElementById('title').value.trim()|| "Untitled";
  const slug=title.toLowerCase().replace(/[^a-z0-9]+/g,'-')+'.html';
  let html=`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>${title}</title><style>body{background:#ff0;margin:40px;font-family:Georgia;font-size:2.2em;line-height:2.1;}img{max-width:50%;margin:60px auto;display:block;border:4px solid #000;}</style></head><body><h1>${title}</h1><p>`;
  let count=0;
  document.querySelectorAll('.section').forEach(sec=>{
    const h=sec.querySelector('.header').value.trim();
    const n=sec.querySelector('.note').value.trim();
    if(h)html+=`<strong>${h}</strong><br><br>`;
    if(n)html+=n.replace(/\n/g,'<br><br>')+'<br><br>';
    sec.querySelectorAll('.thumb').forEach(img=>{if(img.src){count++;const name=`${slug.replace('.html','')}-${count}.jpg`;html+=`<div style="text-align:center"><img src="images/${name}"></div><br>`}});
  });
  html+=`<em>Tags: ${tags.join(', ')||'none'}</em><br>`;
  html+=`<a href="index.html" style="background:#fff;color:#000;padding:30px;display:block;border:4px solid #000;">← Return to Law Book Links</a></body></html>`;
  window.open(`https://github.com/iowacattails/my-law-notes/new/main?filename=${slug}&value=${encodeURIComponent(html)}`,'_blank');
}

function saveDraft(){localStorage.draft=JSON.stringify({title:document.getElementById('title').value,tags:tags,sections:Array.from(document.querySelectorAll('.section')).map(s=>({header:s.querySelector('.header').value,note:s.querySelector('.note').value,cite:s.querySelector('.cite').value,source:s.querySelector('.source').value}))})}
function loadDraft(){if(localStorage.draft){const d=JSON.parse(localStorage.draft);document.getElementById('title').value=d.title;tags=d.tags||[];updatePreview()}}
updatePreview();
</script>
</body>
</html>
