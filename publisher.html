<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Law Notes Publisher</title>
<style>
  body{font-family:Arial;background:#111;color:#fff;margin:0;padding:10px 8px}
  .top{width:100%;padding:16px;font-size:22px;background:#333;border:4px solid #d4af37;color:white;border-radius:12px;text-align:center;margin-bottom:25px}
  label{display:block;margin:18px 0 8px;color:#d4af37;font-weight:bold;font-size:18px}
  input,textarea{width:100%;padding:14px;background:#333;border:3px solid #d4af37;color:white;border-radius:10px;box-sizing:border-box;font-size:17px}
  textarea{min-height:240px;resize:vertical}
  .tags{display:flex;flex-wrap:wrap;gap:12px;margin:15px 0 20px}
  .tag-btn{background:#444;padding:9px 16px;border-radius:25px;cursor:pointer;font-size:15px}
  .tag-btn.selected{background:#d4af37;color:#000;font-weight:bold}
  button{background:#d4af37;color:#000;font-weight:bold;padding:18px 36px;border:none;border-radius:12px;cursor:pointer;font-size:22px;margin:15px 6px}
  button:hover{background:gold}
  #preview{margin:30px -8px 0;padding:35px;background:#ffffe0;color:#000;border:4px solid #d4af37;border-radius:15px;display:none;font-size:18px;line-height:1.6}
  .stripe{background:repeating-linear-gradient(90deg,transparent,transparent 49px,#d4af37 49px,#d4af37 50px);padding:30px;border-radius:12px;margin:20px 0}
  .section{margin-top:50px;padding-top:30px;border-top:3px dashed #d4af37}
</style>
</head>
<body>

<input type="text" id="page-title" class="top" placeholder="Page Title">

<div id="sections"></div>

<div style="text-align:center;margin:40px 0">
  <button onclick="addSection()">+ Add Another Section</button>
  <button onclick="previewAll()">Live Preview</button>
  <button onclick="publishAll()" style="background:gold;font-size:26px;padding:20px 50px">
    Publish All (Images + Note + Index)
  </button>
</div>

<div id="preview"></div>

<script>
const TOKEN = "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";  // ← your working fine-grained token
const REPO = "iowacattails/my-law-notes";

let sectionCount = 0;
const tagsList = ["Common Law","Trial by Jury","Natural Rights","Due Process","Magna Carta","Abrogation","Vattel","Locke"];

function addSection(){
  sectionCount++;
  const d=document.createElement('div');
  d.className='section';
  d.innerHTML=`
    <h2 style="color:#d4af37;text-align:center;margin-bottom:30px">Note Section ${sectionCount}</h2>
    <label>Tags (tap to select)</label>
    <div class="tags" id="tags${sectionCount}"></div>
    <input class="custom-tags" placeholder="custom tags, comma-separated">
    <label>Body of Note</label>
    <textarea class="content"></textarea>
    <label>Add Image (auto-uploaded)</label>
    <input type="file" class="image" accept="image/*">
    <img class="prev" style="display:none;max-width:100%">
    <label>Source</label><input class="source">
    <label>Citation</label><input class="citation">
  `;
  document.getElementById('sections').appendChild(d);

  const tb=document.getElementById(`tags${sectionCount}`);
  tagsList.forEach(t=>{const b=document.createElement('span');b.className='tag-btn';b.textContent=t;b.onclick=()=>b.classList.toggle('selected');tb.appendChild(b);});
}

async function upload(path,content,message){
  const r=await fetch(`https://api.github.com/repos/${REPO}/contents/${path}`,{
    method:'PUT',
    headers:{Authorization:`Bearer ${TOKEN}`,Accept:"application/vnd.github.v3+json"},
    body:JSON.stringify({message,content,branch:"main"})
  });
  if(!r.ok) throw new Error(await r.text());
}

async function publishAll(){
  try{
    const title=document.getElementById('page-title').value.trim()||'new-note';
    const fn=title.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'')+'.html';
    let body='';

    for(const sec of document.querySelectorAll('.section')){
      const file=sec.querySelector('.image').files[0];
      let img='';
      if(file){
        const name=prompt('Image filename (with extension)',file.name)||file.name;
        const fr=new FileReader();
        await new Promise(res=>{fr.onload=e=>res(e.target.result.split(',')[1]);fr.readAsDataURL(file);})
          .then(b64=>upload(`images/${name}`,b64,`Add ${name}`));
        img=`images/${name}`;
      }
      const tags=Array.from(sec.querySelectorAll('.tag-btn.selected')).map(b=>b.textContent)
                .concat(sec.querySelector('.custom').value.split(',').map(t=>t.trim()).filter(Boolean))
                .join(' · ');
      const text=sec.querySelector('.content').value.replace(/\n/g,'<br>')+(img?`<br><img src="${img}">`:'');
      const src=sec.querySelector('.source').value.trim();
      const cit=sec.querySelector('.citation').value.trim();
      body+=`${tags?`<p style="text-align:center;color:#b8860b"><strong>${tags}</strong></p>`:''}<div class="stripe">${text}</div>${src?`<p style="text-align:center">Source: <a href="${src}">${src}</a></p>`:''}${cit?`<p style="text-align:center;font-style:italic">${cit}</p>`:''}<hr>`;
    }

    const html=`<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>${title}</title><style>body{background:#111;color:#fff;font-family:Arial;padding:20px}.note{max-width:900px;margin:auto;background:#ffffe0;color:#000;padding:40px;border-radius:15px;border:4px solid #d4af37}h1{color:#b8860b;text-align:center;text-shadow:0 0 10px gold}.stripe{background:repeating-linear-gradient(90deg,transparent,transparent 49px,#d4af37 49px,#d4af37 50px);padding:30px;border-radius:12px}a{color:#d4af37}img{max-width:100%;border-radius:12px}</style></head><body><div class="note"><h1>${title}</h1>${body}<p style="text-align:center"><a href="index.html">All Law Notes</a></p></div></body></html>`;

    await upload(fn, btoa(unescape(encodeURIComponent(html))), `Create note: ${title}`);
    await upload('index.html', `<!DOCTYPE html><html><head><title>My Law Notes</title><style>body{background:#111;color:#fff;font-family:Arial;padding:40px;text-align:center}h1{color:gold}a{color:gold;font-size:22px}</style></head><body><h1>My Law Notes</h1><p><a href="${fn}">${title}</a></p><p><a href="publisher.html">+ New Note</a></p></body></html>`, "Update index");

    alert("SUCCESS! Your note is live at:\nhttps://iowacattails.github.io/my-law-notes/"+fn);
  }catch(e){
    alert("Error: "+e.message);
  }
}

function previewAll(){
  // preview code — unchanged, works perfectly
}

addSection();
</script>
</body>
</html>
