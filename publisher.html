<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Law Notes Publisher</title>
<style>
  body{font-family:Arial;background:#111;color:#fff;margin:0;padding:12px 10px}
  .version{font-size:15px;color:#d4af37;text-align:center;margin:8px 0 20px;font-weight:bold}
  .top{width:100%;padding:20px;font-size:24px;background:#333;border:5px solid #d4af37;color:#fff;border-radius:20px;text-align:center;box-sizing:border-box}
  label{display:block;margin:22px 0 10px;color:#d4af37;font-weight:bold;font-size:19px}
  input,textarea,.header-box{width:100%;padding:16px;background:#333;border:5px solid #d4af37;color:#fff;border-radius:18px;box-sizing:border-box;font-size:18px}
  textarea{min-height:280px;resize:vertical}
  .header-box{min-height:60px;background:#222;color:#d4af37;text-align:center;font-size:19px}
  .tags{display:flex;flex-wrap:wrap;gap:12px;margin:18px 0}
  .tag-btn{background:#444;padding:11px 20px;border-radius:30px;font-size:16px;cursor:pointer}
  .tag-btn.selected{background:#d4af37;color:#000;font-weight:bold}
  button{background:#d4af37;color:#000;font-weight:bold;border:none;border-radius:20px;cursor:pointer;margin:20px 8px;font-size:24px}
  .add-btn{padding:18px 40px}
  .publish-btn{padding:28px 80px;background:gold;font-size:32px}
  .test-btn{padding:12px 30px;background:#87CEEB;color:#000;font-size:20px}
  button:hover{opacity:0.9;transform:scale(1.03)}
  #preview{margin:40px -10px 0;padding:40px;background:#ffffe0;color:#000;border:6px solid #d4af37;border-radius:20px;font-size:19px;line-height:1.7}
  .stripe{background:repeating-linear-gradient(90deg,transparent,transparent 49px,#d4af37 49px,#d4af37 50px);padding:35px;border-radius:15px;margin:25px 0}
  .section{margin-top:60px;padding-top:40px;border-top:3px dashed #d4af37}
  .back{text-align:center;margin:90px 0 40px;font-size:26px;font-weight:bold}
  .back a{color:#d4af37;text-decoration:underline}
  .img-prev{max-width:100%;border-radius:15px;margin:20px 0;border:4px solid #d4af37;display:block}
</style>
</head>
<body>

<!-- VERSION 4.9 – FINAL WORKING (Dec 5 2025) -->

<div class="version">VERSION 4.9 – FINAL WORKING (Dec 5 2025)</div>

<input type="text" id="page-title" class="top" placeholder="Page Title">

<div id="sections"></div>

<div style="text-align:center;margin:60px 0">
  <button class="test-btn" onclick="testAPI()">Test API Connection</button>
  <button class="add-btn" onclick="addSection()">+ Add Another Section</button>
</div>
<div style="text-align:center">
  <button class="publish-btn" onclick="publishAll()">Publish All<br>(Images + Note + Index)</button>
</div>

<div id="preview"></div>

<div class="back">
  <a href="https://iowacattails.github.io/my-law-notes/">Back to All Law Notes</a>
</div>

<script>
const GITHUB_TOKEN = "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";
const REPO = "iowacattails/my-law-notes";

async function api(path = "", method = "GET", body = null) {
  const url = `https://api.github.com/repos/${REPO}/contents/${path}`;
  const headers = {
    Authorization: `token ${GITHUB_TOKEN}`,
    Accept: "application/vnd.github.v3+json"
  };
  const opts = { method, headers };
  if (body) opts.body = JSON.stringify({ ...body, branch: "main", committer: { name: "Publisher", email: "pub@law.com" } });

  const r = await fetch(url, opts);
  if (!r.ok) {
    const e = await r.text();
    throw new Error(`GitHub ${r.status}: ${e}`);
  }
  return r.json();
}

async function testAPI() {
  try { await api(); alert("API GOOD! Ready to publish."); }
  catch (e) { alert("API FAIL: " + e.message); }
}

function previewAll() {
  const title = document.getElementById("page-title").value.trim() || "Preview";
  let h = `<h1 style="text-align:center;color:#b8860b;text-shadow:0 0 12px gold">${title}</h1>`;
  document.querySelectorAll(".section").forEach(s => {
    const tags = [...s.querySelectorAll(".tag-btn.selected")].map(b=>b.textContent).join(" · ");
    const header = s.querySelector(".header-box").innerText.trim();
    const body = s.querySelector(".content").value.replace(/\n/g,"<br>");
    const img = s.querySelector(".img-prev").style.display==="block" ? s.querySelector(".img-prev").outerHTML : "";
    const src = s.querySelector(".source").value.trim();
    const cit = s.querySelector(".citation").value.trim();
    if (tags) h += `<p style="text-align:center;color:#b8860b"><strong>${tags}</strong></p>`;
    if (header) h += `<h2 style="text-align:center;color:#d4af37">${header}</h2>`;
    h += `<div class="stripe">${body}${img}</div>`;
    if (src) h += `<p style="text-align:center">Source: <a href="${src}" style="color:#d4af37">${src}</a></p>`;
    if (cit) h += `<p style="text-align:center;font-style:italic">${cit}</p><hr style="border:1px dashed #d4af37">`;
  });
  document.getElementById("preview").innerHTML = h;
}

async function publishAll() {
  try {
    // create images folder if missing
    try { await api("images/.gitkeep", "PUT", { message: "init images", content: "" }); } catch(e) {}

    const title = document.getElementById("page-title").value.trim() || "Note";
    const slug = title.toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"") + ".html";

    // upload images
    for (const sec of document.querySelectorAll(".section")) {
      const file = sec.querySelector(".image").files[0];
      if (file) {
        const name = prompt("Image filename", file.name) || `img-${Date.now()}.jpg`;
        const b64 = await new Promise(r => { const fr = new FileReader(); fr.onload = () => r(fr.result.split(",")[1]); fr.readAsDataURL(file); });
        await api(`images/${name}`, "PUT", { message: `Add ${name}`, content: b64 });
      }
    }

    // create note
    const noteHTML = `<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>${title}</title><style>body{background:#111;color:#fff;font-family:Arial;padding:20px}.note{max-width:900px;margin:auto;background:#ffffe0;color:#000;padding:40px;border-radius:20px;border:6px solid #d4af37}h1{color:#b8860b;text-align:center;text-shadow:0 0 10px gold}.stripe{background:repeating-linear-gradient(90deg,transparent,transparent 49px,#d4af37 49px,#d4af37 50px);padding:35px;border-radius:15px}a{color:#d4af37}img{max-width:100%;border-radius:15px}</style></head><body><div class="note"><h1>${title}</h1>${document.getElementById("preview").innerHTML}<p style="text-align:center"><a href="index.html">All Law Notes</a></p></div></body></html>`;

    await api(slug, "PUT", { message: `Publish: ${title}`, content: btoa(unescape(encodeURIComponent(noteHTML))) });

    // update index grid
    const idx = await api("index.html");
    let content = atob(idx.content);
    const match = content.match(/const notes = (\[[\s\S]*?\]);/);
    let notes = match ? JSON.parse(match[1]) : [];
    if (!notes.some(n => n.file === slug)) {
      notes.push({ title, file: slug });
      notes.sort((a,b) => a.title.localeCompare(b.title));
      content = content.replace(/const notes = \[[\s\S]*?\];/, `const notes = ${JSON.stringify(notes, null, 2)};`);
      await api("index.html", "PUT", { message: `Index: add ${title}`, content: btoa(content), sha: idx.sha });
    }

    alert(`VERSION 4.9 SUCCESS!\nhttps://iowacattails.github.io/my-law-notes/${slug}\nRefresh main page – your button is there.`);
  } catch (e) { alert("Failed: " + e.message); }
}

// init
let sectionCount = 0;
function addSection() {
  sectionCount++;
  const d = document.createElement("div"); d.className = "section";
  d.innerHTML = `<h2 style="color:#d4af37;text-align:center">Section ${sectionCount}</h2><label>Tags</label><div class="tags" id="t${sectionCount}"></div><input class="custom-tags" placeholder="custom tags"><div class="header-box" contenteditable></div><label>Body</label><textarea class="content"></textarea><label>Image</label><input type="file" class="image" accept="image/*"><img class="img-prev" style="display:none"><label>Source</label><input class="source"><label>Citation</label><input class="citation">`;
  document.getElementById("sections").appendChild(d);
  const tb = document.getElementById(`t${sectionCount}`);
  ["Common Law","Trial by Jury","Natural Rights","Due Process","Magna Carta","Abrogation","Vattel","Locke","Bill of Rights","Constitution","Habeas Corpus","Jury Nullification"].forEach(t => {
    const b = document.createElement("span"); b.className="tag-btn"; b.textContent=t;
    b.onclick = () => { b.classList.toggle("selected"); previewAll(); };
    tb.appendChild(b);
  });
  d.querySelectorAll("input,textarea,.header-box").forEach(el => el.oninput = previewAll);
  d.querySelector(".image").onchange = e => {
    if (e.target.files[0]) {
      const prev = d.querySelector(".img-prev");
      prev.src = URL.createObjectURL(e.target.files[0]);
      prev.style.display = "block";
      previewAll();
    }
  };
}
addSection();
previewAll();
</script>
</body>
</html>
