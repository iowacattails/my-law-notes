<!-- VERSION 4.2 ‚Äî Auto-Index + Bulletproof Uploads -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Law Notes Publisher</title>
<style>
  body{font-family:Arial;background:#111;color:#fff;margin:0;padding:10px 8px}
  .version{font-size:14px;color:#d4af37;text-align:center;margin-bottom:8px}
  .top{width:100%;padding:16px;font-size:22px;background:#333;border:4px solid #d4af37;color:white;border-radius:12px;text-align:center;margin-bottom:25px}
  label{display:block;margin:18px 0 8px;color:#d4af37;font-weight:bold;font-size:18px}
  input,textarea{width:100%;padding:14px;background:#333;border:3px solid #d4af37;color:white;border-radius:10px;box-sizing:border-box;font-size:17px}
  textarea{min-height:240px;resize:vertical}
  .tags{display:flex;flex-wrap:wrap;gap:12px;margin:15px 0 20px}
  .tag-btn{background:#444;padding:9px 16px;border-radius:25px;cursor:pointer;font-size:15px}
  .tag-btn.selected{background:#d4af37;color:#000;font-weight:bold}
  .header-box{width:100%;padding:12px;background:#333;border:3px solid #d4af37;color:#d4af37;border-radius:10px;font-size:18px;text-align:center;margin:20px 0}
  button{background:#d4af37;color:#000;font-weight:bold;padding:18px 36px;border:none;border-radius:12px;cursor:pointer;font-size:22px;margin:15px 6px}
  button:hover{background:gold}
  #preview{margin:30px -8px 0;padding:35px;background:#ffffe0;color:#000;border:4px solid #d4af37;border-radius:15px;display:block;font-size:18px;line-height:1.6}
  .stripe{background:repeating-linear-gradient(90deg,transparent,transparent 49px,#d4af37 49px,#d4af37 50px);padding:30px;border-radius:12px;margin:20px 0}
  .section{margin-top:50px;padding-top:30px;border-top:3px dashed #d4af37}
  .back{text-align:center;margin:60px 0 20px;font-size:20px}
  .back a{color:#d4af37;text-decoration:underline}
  .test-btn{background:lightblue;color:#000;padding:10px 20px;font-size:16px}
</style>
</head>
<body>

<div class="version">VERSION 4.2 ‚Äî Auto-Index Magic</div>

<input type="text" id="page-title" class="top" placeholder="Page Title">

<div id="sections"></div>

<div style="text-align:center;margin:40px 0">
  <button class="test-btn" onclick="testAPI()">Test API Connection</button>
  <button onclick="addSection()">+ Add Another Section</button>
  <button onclick="publishAll()" style="background:gold;font-size:28px;padding:22px 70px">
    Publish All (Images + Note + Index)
  </button>
</div>

<div id="preview"></div>

<div class="back"><a href="index.html">‚Üê Back to All Law Notes</a></div>

<script>
const TOKEN = "YOUR_NEW_TOKEN_HERE";  // ‚Üê SWAP THIS IMMEDIATELY!
const REPO = "iowacattails/my-law-notes";

let sectionCount = 0;
const tagsList = ["Common Law","Trial by Jury","Natural Rights","Due Process","Magna Carta","Abrogation","Vattel","Locke"];

function addSection() {
  sectionCount++;
  const d = document.createElement('div');
  d.className = 'section';
  d.innerHTML = `
    <h2 style="color:#d4af37;text-align:center;margin-bottom:30px">Note Section ${sectionCount}</h2>
    <label>Tags (tap to select)</label>
    <div class="tags" id="tags${sectionCount}"></div>
    <input type="text" class="custom-tags" placeholder="Add custom tags, comma-separated">
    <div class="header-box" contenteditable="true">Section Header / Context</div>
    <label>Body of Note</label>
    <textarea class="content" placeholder="Write your full note here..."></textarea>
    <label>Add Image (auto-uploaded)</label>
    <input type="file" class="image" accept="image/*">
    <img class="img-prev" style="display:none;max-width:100%">
    <label>Source (link or book)</label>
    <input type="text" class="source">
    <label>Citation (quote/reference)</label>
    <input type="text" class="citation">
  `;
  document.getElementById('sections').appendChild(d);

  const tb = document.getElementById(`tags${sectionCount}`);
  tagsList.forEach(t => {
    const b = document.createElement('span');
    b.className = 'tag-btn';
    b.textContent = t;
    b.onclick = () => { b.classList.toggle('selected'); previewAll(); };
    tb.appendChild(b);
  });

  d.querySelectorAll('input, textarea, .header-box').forEach(el => el.oninput = previewAll);
  d.querySelector('.image').onchange = (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (ev) => d.querySelector('.img-prev').src = ev.target.result;
      reader.readAsDataURL(file);
      d.querySelector('.img-prev').style.display = 'block';
    }
    previewAll();
  };
}

async function apiCall(path, options) {
  const url = `https://api.github.com/repos/${REPO}/contents/${path}`;
  const response = await fetch(url, {
    ...options,
    headers: {
      'Authorization': `token ${TOKEN}`,
      'Accept': 'application/vnd.github.v3+json',
      'Content-Type': 'application/json',
      ...options.headers
    }
  });
  if (!response.ok) {
    const err = await response.text();
    throw new Error(`${response.status}: ${err}`);
  }
  return response.json();
}

async function upload(path, content, msg, existingSha = null) {
  const body = {
    message: msg,
    content: btoa(unescape(encodeURIComponent(content))),  // UTF-8 safe base64
    branch: 'main',
    committer: { name: 'Law Notes Publisher', email: 'noreply@example.com' }  // Fixes 404 on missing committer
  };
  if (existingSha) body.sha = existingSha;
  await apiCall(path, { method: 'PUT', body: JSON.stringify(body) });
}

async function getFile(path) {
  try {
    const res = await apiCall(path, { method: 'GET' });
    return { content: atob(unescape(encodeURIComponent(res.content))), sha: res.sha };
  } catch (e) {
    if (e.message.includes('404')) return { content: '', sha: null };
    throw e;
  }
}

async function testAPI() {
  try {
    await apiCall('');  // Just ping repo
    alert('‚úÖ API good! Token works, repo accessible.');
  } catch (e) {
    alert('‚ùå API fail: ' + e.message + '\nCheck token/perms (needs "repo" scope).');
  }
}

async function publishAll() {
  try {
    const title = document.getElementById('page-title').value.trim() || 'new-note';
    const fn = title.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'') + '.html';
    let body = '';

    for (const sec of document.querySelectorAll('.section')) {
      const file = sec.querySelector('.image').files[0];
      let img = '';
      if (file) {
        const name = prompt('Image filename (with .jpg/.png)', file.name) || `img-${Date.now()}.jpg`;
        const reader = new FileReader();
        const b64 = await new Promise(resolve => {
          reader.onload = () => resolve(reader.result.split(',')[1]);
          reader.readAsDataURL(file);
        });
        await upload(`images/${name}`, b64, `Upload image: ${name}`);
        img = `images/${name}`;
      }
      const tags = Array.from(sec.querySelectorAll('.tag-btn.selected')).map(b => b.textContent)
                   .concat(sec.querySelector('.custom-tags').value.split(',').map(t => t.trim()).filter(Boolean))
                   .join(' ¬∑ ');
      const header = sec.querySelector('.header-box').innerText.trim();
      const text = sec.querySelector('.content').value.replace(/\n/g, '<br>') + (img ? `<br><img src="${img}">` : '');
      const src = sec.querySelector('.source').value.trim();
      const cit = sec.querySelector('.citation').value.trim();
      body += tags ? `<p style="text-align:center;color:#b8860b"><strong>${tags}</strong></p>` : '';
      if (header) body += `<h2 style="text-align:center;color:#d4af37">${header}</h2>`;
      body += `<div class="stripe">${text}</div>`;
      if (src) body += `<p style="text-align:center">Source: <a href="${src}">${src}</a></p>`;
      if (cit) body += `<p style="text-align:center;font-style:italic">${cit}</p>`;
      body += '<hr>';
    }

    const noteHTML = `<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>${title}</title><style>body{background:#111;color:#fff;font-family:Arial;padding:20px}.note{max-width:900px;margin:auto;background:#ffffe0;color:#000;padding:40px;border-radius:15px;border:4px solid #d4af37}h1{color:#b8860b;text-align:center;text-shadow:0 0 10px gold}.stripe{background:repeating-linear-gradient(90deg,transparent,transparent 49px,#d4af37 49px,#d4af37 50px);padding:30px;border-radius:12px}a{color:#d4af37}img{max-width:100%;border-radius:12px}</style></head><body><div class="note"><h1>${title}</h1>${body}<p style="text-align:center"><a href="index.html">All Law Notes</a></p></div></body></html>`;

    await upload(fn, noteHTML, `Create note: ${title}`);

    // Update index
    const { content: indexContent, sha: indexSha } = await getFile('index.html');
    let newIndex = indexContent || `# My Law Notes\n\n## Notes & Historical Law Book Links\n\nTAGS\n\n + [Create New Note (private tool)](publisher.html)\n\n### All Notes\n`;
    const newLink = `\n- [${title}](${fn}) ${img ? `![Preview](${img})` : ''}`;
    newIndex = newIndex.replace(/### All Notes\n/, `### All Notes${newLink}`);  // Append if section exists, else add
    if (!newIndex.includes('### All Notes')) newIndex += `\n\n### All Notes${newLink}`;
    await upload('index.html', newIndex, `Update index: Add ${title}`, indexSha);

    alert(`üéâ SUCCESS! Note live: https://iowacattails.github.io/my-law-notes/${fn}\nIndex updated‚Äîrefresh to see it!`);
  } catch (e) {
    alert("Error: " + e.message + "\n(Try 'Test API' first‚Äîmight be token/perms.)");
  }
}

function previewAll() {
  let preview = '<h1 id="preview-title"></h1>';
  document.querySelectorAll('.section').forEach(sec => {
    const tags = Array.from(sec.querySelectorAll('.tag-btn.selected')).map(b => b.textContent).join(', ');
    const header = sec.querySelector('.header-box').innerText;
    const text = sec.querySelector('.content').value.replace(/\n/g, '<br>');
    const img = sec.querySelector('.img-prev').src;
    preview += `<p><strong>Tags:</strong> ${tags}</p><h2>${header}</h2><div class="stripe">${text}${img ? `<br><img src="${img}">` : ''}</div><hr>`;
  });
  document.getElementById('preview-title').textContent = document.getElementById('page-title').value || 'Preview';
  document.getElementById('preview').innerHTML = preview;
}

document.addEventListener('input', previewAll);
document.addEventListener('change', previewAll);

addSection();
previewAll();
</script>
</body>
</html>
