<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Law Notes Publisher</title>
<style>
  body{font-family:Arial;background:#111;color:#fff;margin:0;padding:10px 8px}
  .version{font-size:14px;color:#d4af37;text-align:center;margin-bottom:8px}
  .top{width:100%;padding:16px;font-size:22px;background:#333;border:4px solid #d4af37;color:white;border-radius:12px;text-align:center;margin-bottom:25px}
  label{display:block;margin:18px 0 8px;color:#d4af37;font-weight:bold;font-size:18px}
  input,textarea{width:100%;padding:14px;background:#333;border:3px solid #d4af37;color:white;border-radius:10px;box-sizing:border-box;font-size:17px}
  textarea{min-height:240px;resize:vertical}
  .tags{display:flex;flex-wrap:wrap;gap:12px;margin:15px 0 20px}
  .tag-btn{background:#444;padding:9px 16px;border-radius:25px;cursor:pointer;font-size:15px}
  .tag-btn.selected{background:#d4af37;color:#000;font-weight:bold}
  .header-box{width:100%;padding:14px;background:#333;border:3px solid #d4af37;color:#fff;border-radius:10px;font-size:18px Arial;text-align:center;margin:20px 0}
  button{background:#d4af37;color:#000;font-weight:bold;padding:18px 36px;border:none;border-radius:12px;cursor:pointer;font-size:22px;margin:15px 6px}
  button:hover{background:gold}
  #preview{margin:30px -8px 0;padding:35px;background:#ffffe0;color:#000;border:4px solid #d4af37;border-radius:15px;font-size:18px;line-height:1.6}
  .stripe{background:repeating-linear-gradient(90deg,transparent,transparent 49px,#d4af37 49px,#d4af37 50px);padding:30px;border-radius:12px;margin:20px 0}
  .section{margin-top:50px;padding-top:30px;border-top:3px dashed #d4af37}
  .back{text-align:center;margin:70px 0 30px;font-size:22px}
  .back a{color:#d4af37;text-decoration:underline}
</style>
</head>
<body>

<div class="version">Law Notes Publisher – Version 4.2 (Auto-index)</div>

<input type="text" id="page-title" class="top" placeholder="Page Title">

<div id="sections"></div>

<div style="text-align:center;margin:50px 0">
  <button onclick="addSection()">+ Add Another Section</button>
  <button onclick="publishAll()" style="background:gold;font-size:28px;padding:22px 80px">
    Publish All – Auto Index
  </button>
</div>

<div id="preview"></div>

<div class="back">
  <a href="https://iowacattails.github.io/my-law-notes/">Back to All Law Notes</a>
</div>

<script>
let sectionCount = 0;
const tagsList = ["Common Law","Trial by Jury","Natural Rights","Due Process","Magna Carta","Abrogation","Vattel","Locke","Bill of Rights","Constitution"];

function addSection() {
  sectionCount++;
  const d = document.createElement('div');
  d.className = 'section';
  d.innerHTML = `
    <h2 style="color:#d4af37;text-align:center;margin-bottom:30px">Note Section ${sectionCount}</h2>
    <label>Tags (tap to select)</label>
    <div class="tags" id="tags${sectionCount}"></div>
    <input type="text" class="custom-tags" placeholder="Custom tags, comma-separated">
    <div class="header-box" contenteditable="true">Section Header / Context</div>
    <label>Body of Note</label>
    <textarea class="content" placeholder="Write your full note here..."></textarea>
    <label>Add Image (opens upload tab)</label>
    <input type="file" class="image" accept="image/*">
    <img class="img-prev" style="display:none;max-width:100%;margin-top:10px;border-radius:8px">
    <label>Source (link or book)</label>
    <input type="text" class="source">
    <label>Citation (quote/reference)</label>
    <input type="text" class="citation">
  `;
  document.getElementById('sections').appendChild(d);

  const tagBox = document.getElementById(`tags${sectionCount}`);
  tagsList.forEach(t => {
    const b = document.createElement('span');
    b.className = 'tag-btn';
    b.textContent = t;
    b.onclick = () => { b.classList.toggle('selected'); previewAll(); };
    tagBox.appendChild(b);
  });

  // Live preview
  d.querySelectorAll('input, textarea, .header-box').forEach(el => el.addEventListener('input', previewAll));
  d.querySelector('.image').onchange = function(e) {
    const file = e.target.files[0];
    if (!file) return;
    const name = prompt('Image filename (with extension)', file.name) || file.name;
    if (name) {
      window.open(`https://github.com/iowacattails/my-law-notes/upload/main/images/${encodeURIComponent(name)}`, '_blank');
      const reader = new FileReader();
      reader.onload = ev => {
        d.querySelector('.img-prev').src = ev.target.result;
        d.querySelector('.img-prev').style.display = 'block';
      };
      reader.readAsDataURL(file);
    }
    previewAll();
  };

  previewAll();
}

function previewAll() {
  const title = document.getElementById('page-title').value.trim() || 'New Note';
  let html = `<h1 style="text-align:center;color:#b8860b;text-shadow:0 0 10px gold;margin-bottom:30px">${title}</h1>`;

  document.querySelectorAll('.section').forEach(sec => {
    const tags = Array.from(sec.querySelectorAll('.tag-btn.selected')).map(b => b.textContent)
                 .concat(sec.querySelector('.custom-tags').value.split(',').map(t=>t.trim()).filter(Boolean))
                 .join(' · ');
    const header = sec.querySelector('.header-box').innerText.trim();
    const text = sec.querySelector('.content').value.replace(/\n/g,'<br>');
    const img = sec.querySelector('.img-prev').style.display === 'block' ? `<br><img src="images/${sec.querySelector('.image').files[0].name}" style="max-width:100%;border-radius:8px">` : '';
    const src = sec.querySelector('.source').value.trim();
    const cit = sec.querySelector('.citation').value.trim();

    if (tags) html += `<p style="text-align:center;color:#b8860b"><strong>${tags}</strong></p>`;
    if (header) html += `<h2 style="text-align:center;color:#d4af37;margin:30px 0">${header}</h2>`;
    html += `<div class="stripe">${text}${img}</div>`;
    if (src) html += `<p style="text-align:center">Source: <a href="${src}">${src}</a></p>`;
    if (cit) html += `<p style="text-align:center;font-style:italic">${cit}</p>`;
    html += `<hr style="border:1px dashed #d4af37;margin:40px 0">`;
  });

  document.getElementById('preview').innerHTML = html;
}

async function publishAll() {
  previewAll();
  const title = document.getElementById('page-title').value.trim() || 'new-note';
  const filename = title.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'') + '.html';

  const fullNoteHTML = `<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>${title}</title>
  <style>
    body{background:#111;color:#fff;font-family:Arial;padding:20px}
    .note{max-width:900px;margin:auto;background:#ffffe0;color:#000;padding:40px;border-radius:15px;border:4px solid #d4af37}
    h1{color:#b8860b;text-align:center;text-shadow:0 0 10px gold}
    h2{color:#d4af37;text-align:center}
    .stripe{background:repeating-linear-gradient(90deg,transparent,transparent 49px,#d4af37 49px,#d4af37 50px);padding:30px;border-radius:12px;margin:20px 0}
    a{color:#d4af37}
    img{max-width:100%;border-radius:8px}
  </style>
</head>
<body>
  <div class="note">
    <h1>${title}</h1>
    ${document.getElementById('preview').innerHTML}
    <p style="text-align:center;margin-top:60px"><a href="index.html">All Law Notes</a></p>
  </div>
</body>
</html>`;

  // Open GitHub to create the new note
  const noteUrl = `https://github.com/iowacattails/my-law-notes/new/main?filename=${filename}&value=${encodeURIComponent(fullNoteHTML)}`;
  window.open(noteUrl, '_blank');

  // Auto-update index.html – newest on top
  const indexUrl = `https://github.com/iowacattails/my-law-notes/edit/main/index.html`;
  const newLine = `  <li style="margin:18px 0;font-size:21px"><a href="${filename}">${title}</a></li>`;
  alert("Note tab opened – commit it!\nThen open this second tab to add it to the index:\n" + indexUrl + "\n\nJust paste this line near the top of the list:\n\n" + newLine);

  // Optional: copy the line to clipboard
  navigator.clipboard.writeText(newLine);
}

addSection();
previewAll();
</script>
</body>
</html>
