<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Law Notes by Tag</title>
<style>
  body {background:#ff0;margin:40px;font-family:Arial;text-align:center;}
  h1 {font-size:3em;}
  .tag {display:inline-block;background:#fff;color:#000;padding:20px 40px;margin:15px;font-size:2em;border:4px solid #000;border-radius:15px;text-decoration:none;font-weight:bold;}
  .tag:hover {background:#000;color:#ff0;}
  .count {font-size:0.6em;display:block;margin-top:10px;}
  #results {margin-top:80px;}
  .note {margin:40px auto;max-width:900px;text-align:left;background:#fff;padding:40px;border:4px solid #000;}
</style>
</head>
<body>
<h1>Law Notes by Tag</h1>
<div id="tags">Loading tags...</div>
<div id="results"></div>

<script>
async function loadTags() {
  try {
    const res = await fetch('https://api.github.com/repos/iowacattails/my-law-notes/git/trees/main?recursive=1');
    const data = await res.json();
    const files = data.tree.filter(f => f.path.endsWith('.html') && !['index.html','publisher.html','tags.html'].includes(f.path.split('/').pop()));

    const tagCount = {};
    const notesByTag = {};

    for (const file of files) {
      const htmlRes = await fetch(file.path);
      const html = await htmlRes.text();
      const match = html.match(/<em>Tags: (.*?)<\/em>/);
      if (match) {
        const tags = match[1].split(', ').map(t => t.trim());
        tags.forEach(t => {
          tagCount[t] = (tagCount[t] || 0) + 1;
          if (!notesByTag[t]) notesByTag[t] = [];
          notesByTag[t].push({file: file.path, title: file.path.replace('.html','').replace(/-/g,' ').replace(/\b\w/g, c=>c.toUpperCase())});
        });
      }
    }

    const sortedTags = Object.keys(tagCount).sort((a,b) => tagCount[b] - tagCount[a]);
    const container = document.getElementById('tags');
    container.innerHTML = '';
    sortedTags.forEach(tag => {
      const a = document.createElement('a');
      a.href = '#';
      a.className = 'tag';
      a.textContent = tag;
      a.innerHTML += `<span class="count">${tagCount[tag]} note${tagCount[tag]>1?'s':''}</span>`;
      a.onclick = () => showNotes(tag, notesByTag[tag]);
      container.appendChild(a);
    });
  } catch (e) {
    document.getElementById('tags').innerHTML = '<p>Tags loading... (check internet)</p>';
  }
}

function showNotes(tag, notes) {
  const results = document.getElementById('results');
  let html = `<h2>Notes tagged "${tag}" (${notes.length})</h2>`;
  notes.forEach(n => {
    html += `<a href="${n.file}" class="note"><strong>${n.title}</strong></a><br><br>`;
  });
  results.innerHTML = html;
  window.scrollTo(0, document.getElementById('results').offsetTop);
}

loadTags();
</script>

<hr style="border:none;border-top:4px solid #000;margin:100px 0;">
<p><a href="index.html" style="font-size:2em;color:#000;text-decoration:none;">‚Üê Back to All Notes</a></p>
</body>
</html>
