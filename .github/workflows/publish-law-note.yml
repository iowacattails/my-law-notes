name: Publish Law Note
on:
  repository_dispatch:
    types: [publish-law-note]

permissions:
  contents: write

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Publish note and update index
        env:
          GITHUB_TOKEN: ${{ secrets.TOKEN }}
        run: |
          python3 - <<'PY'
          import os, json, base64, requests

          # Get payload
          with open(os.environ['GITHUB_EVENT_PATH']) as f:
            event = json.load(f)
          payload = event['client_payload']
          title = payload['title']
          slug = payload['slug']
          html_b64 = payload['html']

          repo = os.environ['GITHUB_REPOSITORY']
          token = os.environ['GITHUB_TOKEN']
          headers = {"Authorization": f"token {token}", "Accept": "application/vnd.github.v3+json"}

          # 1. Save the new note
          requests.put(
            f"https://api.github.com/repos/{repo}/contents/{slug}",
            headers=headers,
            json={"message": f"Publish: {title}", "content": html_b64, "branch": "main"}
          )
          print(f"Saved {slug}")

          # 2. Update index.html (add new button manually)
          idx_resp = requests.get(f"https://api.github.com/repos/{repo}/contents/index.html", headers=headers)
          if idx_resp.status_code != 200:
            print(f"Error getting index.html: {idx_resp.status_code}")
            exit(1)
          idx_data = idx_resp.json()
          content = base64.b64decode(idx_data['content']).decode('utf-8')

          # Add new button before the + Create New Note
          new_button = f'<a href="{slug}" class="note-btn">{title}</a>'
          if new_button not in content:
            content = content.replace('<a href="publisher.html" class="note-btn" style="background:gold">+ Create New Note (private tool).</a>', new_button + '\n<a href="publisher.html" class="note-btn" style="background:gold">+ Create New Note (private tool).</a>')
            requests.put(
              f"https://api.github.com/repos/{repo}/contents/index.html",
              headers=headers,
              json={
                "message": f"Index: add {title}",
                "content": base64.b64encode(content.encode()).decode(),
                "sha": idx_data['sha'],
                "branch": "main"
              }
            )
            print(f"Index updated with {title}")
          else:
            print(f"Note {title} already in index")
          PY
