name: Publish Law Note
on:
  repository_dispatch:
    types: [publish-law-note]

permissions:
  contents: write

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Publish
        env:
          GITHUB_TOKEN: ${{ secrets.TOKEN }}
        run: |
          python3 - <<'PY'
          import os, json, base64, requests, re, random, string

          payload = json.load(open(os.environ['GITHUB_EVENT_PATH']))['client_payload']
          title = payload['title']
          slug = payload['slug']
          sections = payload['sections']

          html = ''
          for sec in sections:
            tags = ' Â· '.join(sec.get('tags', [])) if sec.get('tags') else ''
            header = sec.get('header', '')
            body = sec.get('body', '').replace('\n', '<br>')
            img = ''
            if sec.get('image'):
              b64 = sec['image']
              name = f"img-{' '.join(random.choices(string.ascii_lowercase + string.digits, k=8))}.jpg"
              requests.put(
                f"https://api.github.com/repos/{os.environ['GITHUB_REPOSITORY']}/contents/images/{name}",
                headers={'Authorization': f"token {os.environ['GITHUB_TOKEN']}"},
                json={'message': f'Add {name}', 'content': b64, 'branch': 'main'}
              )
              img = f'<br><img src="images/{name}">'
            source = sec.get('source', '')
            citation = sec.get('citation', '')

            if tags: html += f'<p style="text-align:center;color:#b8860b"><strong>{tags}</strong></p>'
            if header: html += f'<h2 style="text-align:center;color:#d4af37">{header}</h2>'
            html += f'<div class="stripe">{body}{img}</div>'
            if source: html += f'<p style="text-align:center">Source: <a href="{source}">{source}</a></p>'
            if citation: html += f'<p style="text-align:center;font-style:italic">{citation}</p>'
            html += '<hr>'

          note_html = f'''<!DOCTYPE html>
          <html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
          <title>{title}</title>
          <style>body{{background:#111;color:#fff;font-family:Arial;padding:20px}}.note{{max-width:900px;margin:auto;background:#ffffe0;color:#000;padding:40px;border-radius:20px;border:6px solid #d4af37}}h1{{color:#b8860b;text-align:center;text-shadow:0 0 12px gold}}.stripe{{background:#fff;padding:30px;border-radius:12px;margin:20px 0}}a{{color:#d4af37}}img{{max-width:100%;border-radius:15px}}</style>
          </head><body><div class="note"><h1>{title}</h1>{html}<p style="text-align:center"><a href="index.html">All Law Notes</a></p></div></body></html>'''

          requests.put(
            f"https://api.github.com/repos/{os.environ['GITHUB_REPOSITORY']}/contents/{slug}",
            headers={'Authorization': f"token {os.environ['GITHUB_TOKEN']}"},
            json={'message': f'Publish: {title}', 'content': base64.b64encode(note_html.encode()).decode(), 'branch': 'main'}
          )

          # Update index
          r_idx = requests.get(f"https://api.github.com/repos/{os.environ['GITHUB_REPOSITORY']}/contents/index.html",
                               headers={'Authorization': f"token {os.environ['GITHUB_TOKEN']}"})
          content = base64.b64decode(r_idx.json()['content']).decode()
          if slug not in content:
            notes = []
            m = re.search(r'const notes = (\[[\s\S]*?\]);', content)
            if m: notes = json.loads(m.group(1))
            notes.append({"title": title, "file": slug})
            notes.sort(key=lambda x: x["title"].lower())
            content = re.sub(r'const notes = \[[\s\S]*?\];', f'const notes = {json.dumps(notes, indent=2)};', content)
            requests.put(
              f"https://api.github.com/repos/{os.environ['GITHUB_REPOSITORY']}/contents/index.html",
              headers={'Authorization': f"token {os.environ['GITHUB_TOKEN']}"},
              json={'message': f'Index: add {title}', 'content': base64.b64encode(content.encode()).decode(), 'sha': r_idx.json()['sha'], 'branch': 'main'}
            )
          print("Published successfully!")
          PY
