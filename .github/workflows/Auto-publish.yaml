name: Auto-Publish Law Note

on:
  repository_dispatch:
    types: [publish-note]

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create note page
        run: |
          cat > "${{ github.event.client_payload.slug }}" << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="UTF-8">
            <title>${{ github.event.client_payload.title }}</title>
            <style>
              body{background:#ff0;margin:40px;font-family:Georgia;font-size:2.2em;line-height:2.1;}
              img{max-width:50%;margin:60px auto;display:block;border:4px solid #000;}
            </style>
          </head>
          <body>
            <h1>${{ github.event.client_payload.title }}</h1>
            <p>${{ github.event.client_payload.content }}</p>
            ${{ github.event.client_payload.image ? '<div style="text-align:center"><img src="' + github.event.client_payload.image + '"></div>' : '' }}
            <em>Tags: ${{ github.event.client_payload.tags }}</em><br><br>
            <a href="index.html" style="background:#fff;color:#000;padding:30px;display:block;border:4px solid #000;">‚Üê Return to Law Book Links</a>
          </body>
          </html>
          EOF

      - name: Update index.html (add new button)
        run: |
          sed -i '/<!-- AUTO-GENERATED NOTES -->/a <a href="${{ github.event.client_payload.slug }}" class="button">${{ github.event.client_payload.title }}</a><br><br>' index.html

      - name: Commit and push
        run: |
          git config user.name "Law Note Bot"
          git config user.email "bot@law-notes"
          git add .
          git commit -m "Auto-publish: ${{ github.event.client_payload.title }}"
          git push
